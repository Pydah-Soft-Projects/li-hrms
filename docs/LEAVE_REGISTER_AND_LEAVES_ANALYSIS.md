# Leave Register & Leaves Module – Complete Analysis

This document explains the **Leave Register** module, **leave policy settings**, how **Employee** stores leave balances (CL, EL, CCL), the end-to-end **flow**, **calculations**, and known **bugs**.

---

## 1. Overview: Two Sources of Truth

| Leave Type | Leave Register (Ledger) | Employee Model Field |
|------------|-------------------------|------------------------|
| **CL** (Casual Leave) | Primary – all CREDIT/DEBIT/EXPIRY/CARRY_FORWARD | `casualLeaves` (synced from register) |
| **EL** (Earned Leave) | Primary – CREDIT from accrual, DEBIT on leave use | `paidLeaves` (synced from register) |
| **CCL** (Compensatory Off) | **Not fully used** – only EXPIRY and DEBIT when availed | `compensatoryOffs` (updated on CCL approval only) |

- **Leave Register** is the ledger: every credit/debit/expiry/adjustment is a document in the `leave_register` collection.
- **Employee** fields are **cache copies** updated by `leaveRegisterService.updateEmployeeBalance()` after each register transaction **for CL and EL**. For **CCL**, only the approval flow updates `Employee.compensatoryOffs`; the register does **not** get a CREDIT when CCL is approved (see Bugs).

---

## 2. Leave Policy Settings (`LeavePolicySettings`)

Stored in `leave_policy_settings` collection. Used by accrual, annual reset, and carry-forward.

### 2.1 Financial Year

- `financialYear.startMonth` (default 4 = April), `startDay`, `useCalendarYear`.
- Used for FY boundaries and payroll cycles (e.g. via `dateCycleService`).

### 2.2 Earned Leave (EL)

- **Enabled**: `earnedLeave.enabled`.
- **Earning type**:
  - **attendance_based**: rules in `earnedLeave.attendanceRules`:
    - `minDaysForFirstEL`, `daysPerEL`, `maxELPerMonth`, `maxELPerYear`
    - `considerPresentDays`, `considerHolidays`
    - `attendanceRanges[]`: `{ minDays, maxDays, elEarned, description }` for tiered EL.
  - **fixed**: `earnedLeave.fixedRules.elPerMonth`, `maxELPerYear`.

### 2.3 Carry Forward

- **CL**: `carryForward.casualLeave` – enabled, maxMonths, expiryMonths, carryForwardToNextYear.
- **EL**: `carryForward.earnedLeave` – same shape.
- **CCL**: `carryForward.compensatoryOff` – maxMonths, expiryMonths, carryForwardToNextYear.

### 2.4 Annual CL Reset

- `annualCLReset.enabled`, `resetToBalance` (e.g. 12), `resetMonth`, `resetDay`, `addCarryForward`.
- **Note**: Annual reset only posts **EXPIRY** for CL above carry-forward limit; it does **not** post the “reset to 12” CREDIT in the current implementation (see flow below).

### 2.5 Encashment & Compliance

- Encashment rules for CL/EL; compliance (e.g. Shops Act, probation, weekly offs) used by EL calculation.

---

## 3. Employee Model – Leave Fields

From `backend/employees/model/Employee.js`:

- **`casualLeaves`** (Number): CL balance cache; updated when register has CL CREDIT/DEBIT/ADJUSTMENT.
- **`paidLeaves`** (Number): **EL** balance cache (name is misleading); updated when register has EL CREDIT/DEBIT/ADJUSTMENT.
- **`compensatoryOffs`** (Number): CCL balance; updated **only** on CCL approval (`$inc`) and when register CCL transactions run (e.g. DEBIT/EXPIRY) and trigger `updateEmployeeBalance('CCL')`.  
  There is **no** register CREDIT when CCL is approved, so register-driven CCL balance can be wrong (see Bugs).

Other fields (sickLeaves, maternityLeaves, onDutyLeaves, allottedLeaves) exist but are not the focus of the register/accrual flow above.

---

## 4. Leave Register Model & Service

### 4.1 Schema (`LeaveRegister`)

- **Identity**: employeeId, empNo, employeeName, designation, department, divisionId, departmentId, dateOfJoining, employmentStatus.
- **Transaction**: leaveType (`'EL'|'CL'|'SL'|'ML'|'OD'|'CCL'|'LWP'`), transactionType (`'CREDIT'|'DEBIT'|'ADJUSTMENT'|'CARRY_FORWARD'|'EXPIRY'`).
- **Dates & amount**: startDate, endDate, days.
- **Ledger**: openingBalance, transactionAmount (stored as `days`), closingBalance.
- **Optional**: applicationId, reason, month, year, financialYear, payrollCycleStart/End, financialYearStart/End, autoGenerated, autoGeneratedType, calculationBreakdown.

Important statics:

- `getEmployeeBalance(employeeId, leaveType, asOfDate)`: latest transaction with `endDate <= asOfDate` for that employee and leave type (by endDate/createdAt desc).
- `getLeaveRegister(filters, month, year)`: list of transactions; if `balanceAsOf` and employeeId/empNo and month/year, query is “all transactions up to (year, month)” sorted chronologically.
- `getCLUsedInYear(employeeIdOrEmpNoFilter, year)`: total CL DEBIT days in that year (for “1 CL per month” cap).

### 4.2 Leave Register Service – Main Flows

1. **addTransaction(transactionData)**  
   - Gets period from `transactionData.startDate` via `dateCycleService.getPeriodInfo`.  
   - Gets previous balance with `LeaveRegister.getEmployeeBalance(employeeId, leaveType, startDate)`.  
   - Creates new row with opening/closing balance, saves, then calls **updateEmployeeBalance(employeeId, leaveType)** so Employee stays in sync (for CL/EL; for CCL only DEBIT/EXPIRY paths hit this).

2. **addEarnedLeaveCredit(employeeId, elEarned, month, year, calculationBreakdown)**  
   - Builds a CREDIT transaction for EL and calls `addTransaction`.

3. **addLeaveDebit(leaveRecord)**  
   - When a leave application is **approved**, controller calls this; it posts a DEBIT to the register and updates employee balance.

4. **getLeaveRegister(filters, month, year)**  
   - Fetches transactions (with optional balance-as-of for one employee).  
   - **Groups by employee** and aggregates by leave type in **groupByEmployeeMonthly**: for each employee, one object with `casualLeave`, `earnedLeave`, `compensatoryOff` (opening, accrued/earned/used/expired, balance, etc.) and `totalPaidBalance`.  
   - **Fallback**: if `balanceAsOf` and single employee and **no** register transactions, returns one row using **Employee.casualLeaves** for CL balance; EL and CCL are returned as 0 (no fallback for them).  
   - For balance-as-of, also enriches CL with `usedThisYear` and `allowedRemaining` (1 CL per month cap from first 12 + balance above 12).

5. **updateEmployeeBalance(employeeId, leaveType)**  
   - Reads current balance from register via `getCurrentBalance(employeeId, leaveType)` and writes to Employee:
     - CL → `casualLeaves`
     - EL → `paidLeaves`
     - CCL → `compensatoryOffs`
     - (others mapped in `getEmployeeBalanceField`)

---

## 5. End-to-End Flow

### 5.1 Casual Leave (CL)

1. **Credits**
   - **Monthly accrual** (`accrualEngine.postMonthlyAccruals`): `calculateCLAccrual` gives 1/12 of annual CL per month (pro-rata if joined mid-cycle); posts CREDIT via `leaveRegisterService.addTransaction` → register + `updateEmployeeBalance('CL')`.
   - **Annual reset**: Only **expiry** is implemented (post EXPIRY for amount above carry-forward); no “reset to 12” CREDIT in code.
   - **Manual**: HR uses “Adjust balance” (e.g. frontend `adjustCLBalance`) → POST `/api/leaves/register/adjust` with leaveType CL → `addTransaction` → Employee updated.

2. **Debits**
   - When a **leave application** with type CL is **approved**, `leaveController` calls `leaveRegisterService.addLeaveDebit(leave)` → DEBIT in register → `updateEmployeeBalance('CL')`.

3. **Balance shown**
   - Leave Register UI: from register aggregation; if balance-as-of and no transactions, fallback to `Employee.casualLeaves`.
   - Apply-leave form (CL balance): same API with `balanceAsOf`, month, year, employeeId/empNo.

### 5.2 Earned Leave (EL)

1. **Credits**
   - **Monthly accrual**: `earnedLeaveService.calculateEarnedLeave(employeeId, month, year, cycleStart, cycleEnd)` (attendance-based or fixed from LeavePolicySettings); if `elEarned > 0`, `leaveRegisterService.addEarnedLeaveCredit(...)` → CREDIT in register → `updateEmployeeBalance('EL')` (writes to `paidLeaves`).

2. **Debits**
   - Same as CL: on approval of an EL leave application, `addLeaveDebit` posts DEBIT and updates `paidLeaves`.

3. **Balance**
   - Register view: from register only (no Employee fallback for EL).
   - `earnedLeaveService.getELBalance()` returns **Employee.paidLeaves** (and carry-forward placeholder); it does **not** read from the register.

### 5.3 Compensatory Off (CCL)

1. **Credits**
   - **Only in Employee**: When a CCL request is **approved** (`cclController.processCCLAction`), code does `$inc: { compensatoryOffs: increment }` (0.5 or 1).  
   - **No CREDIT is posted to the Leave Register** on CCL approval. So the register has no “earned CCL” entries.

2. **Debits / Expiry**
   - When employee **avails** CCL (leave type CCL approved): same `addLeaveDebit` path → DEBIT in register → `updateEmployeeBalance('CCL')`.
   - **Monthly accrual**: `processCCLExpiration` finds old approved CCL requests past expiry and posts **EXPIRY** to the register and marks CCL as expired; `updateEmployeeBalance('CCL')` runs.

3. **Balance shown**
   - Leave Register UI: CCL balance is derived **only from register** (credits + debits + expiry). Because no CREDIT is posted on approval, the register balance for CCL is **understated** (often 0 or negative from debits/expiry only).

### 5.4 CL “1 per month” Cap

- Allowed CL usage in a year uses: `min(12, month) + max(0, balance - 12) - usedThisYear`.
- `usedThisYear` = `LeaveRegister.getCLUsedInYear(employeeId, year)` (sum of CL DEBIT days in that year).
- Used when `balanceAsOf` is true to set `allowedRemaining` on the register response.

---

## 6. Calculations Summary

| What | Where | Formula / Logic |
|------|--------|------------------|
| CL accrual per month | accrualEngine | (annualCL/12) with pro-rata by join date in cycle; steps of 0.5. |
| EL (attendance-based) | earnedLeaveService | Attendance days in cycle vs minDaysForFirstEL, daysPerEL, maxELPerMonth, maxELPerYear; optional attendanceRanges. |
| EL (fixed) | earnedLeaveService | fixedRules.elPerMonth, capped by maxELPerYear. |
| Register balance | LeaveRegister | Last transaction’s closingBalance for that employee + leaveType up to asOfDate. |
| Employee balance | Employee doc | casualLeaves (CL), paidLeaves (EL), compensatoryOffs (CCL); kept in sync only where register is updated (CCL approval does not update register). |
| CL allowed remaining | leaveRegisterService | min(12, month) + max(0, balance - 12) - getCLUsedInYear. |

---

## 7. Bugs and Inconsistencies (Resolved)

### 7.1 ~~CCL not posted to Leave Register on approval (High)~~ Fixed

- **Where**: `backend/leaves/controllers/cclController.js` (processCCLAction on approve).
- **Fix applied**: On CCL approval we now call `leaveRegisterService.addTransaction(...)` with a CREDIT for CCL. `updateEmployeeBalance('CCL')` inside addTransaction syncs `Employee.compensatoryOffs` from the register. The previous `$inc` on Employee was removed to avoid double-counting.

### 7.2 ~~Fallback uses only CL from Employee (Medium)~~ Fixed

- **Where**: `leaveRegisterService.getLeaveRegister` – when balanceAsOf and no register transactions.
- **Fix applied**: Fallback now selects `paidLeaves` and `compensatoryOffs` and sets `earnedLeave.balance` and `compensatoryOff.balance` from them; `totalPaidBalance` is the sum of CL + EL + CCL.

### 7.3 ~~getEmployeeRegister uses wrong Employee fields (Medium)~~ Fixed

- **Where**: `leaveRegisterService.getEmployeeRegister`.
- **Fix applied**: Now returns `employeeName: employee.employee_name || 'N/A'` and `dateOfJoining: employee.doj`.

### 7.4 getCLResetStatus uses paidLeaves for “currentCL” (High)

- **Where**: `annualCLResetService.getCLResetStatus`.
- **What**: Returns `currentCL: emp.paidLeaves || 0`. CL is stored in `casualLeaves`; `paidLeaves` is EL.
- **Effect**: CL reset status shows EL balance as “current CL”.
- **Fix**: Use `emp.casualLeaves` (or register-based CL balance) for `currentCL`.

### 7.5 EL stored in “paidLeaves” (Low / Design)

- **Where**: Employee model; `leaveRegisterService.getEmployeeBalanceField('EL')` → `'paidLeaves'`.
- **What**: Naming is generic; in this codebase “paidLeaves” is used only for EL.
- **Effect**: Confusing for developers; no functional bug if everyone knows the convention.
- **Fix**: Optional: rename to `earnedLeaves` and migrate, or document clearly.

### 7.6 ~~addLeaveDebit uses employee.name (Low)~~ Fixed

- **Where**: `leaveRegisterService.addLeaveDebit`.
- **Fix applied**: `employeeName` now uses `employee.employee_name || 'N/A'`; `dateOfJoining` uses `employee.doj` only.

---

## 8. UI / API Summary

- **Leave Register page** (admin/superadmin): GET `/api/leaves/register?month=&year=` (and optional filters). Displays table of employees with CL, EL, CCL balances and totals from **grouped register data** (CCL credits are now posted on approval).
- **Apply leave form**: GET register with `balanceAsOf=true&employeeId=&month=&year=` to show CL/EL/CCL balance; fallback to Employee for all three when no register transactions.
- **Adjust balance**: POST `/api/leaves/register/adjust` (body: employeeId, leaveType, amount, transactionType, reason). Frontend `adjustCLBalance` sends leaveType `'CL'` and maps +/- days to CREDIT/DEBIT.
- **Employee register detail**: GET `/api/leaves/register/employee/:employeeId` uses `getEmployeeRegister` (name and DOJ now from correct fields).

---

## 9. Files Reference

| Area | Files |
|------|--------|
| Register model | `backend/leaves/model/LeaveRegister.js` |
| Register service | `backend/leaves/services/leaveRegisterService.js` |
| Register controller | `backend/leaves/controllers/leaveRegisterController.js` |
| Policy settings | `backend/settings/model/LeavePolicySettings.js` |
| Accrual | `backend/leaves/services/accrualEngine.js`, `earnedLeaveService.js` |
| Annual CL | `backend/leaves/services/annualCLResetService.js` |
| Leave approval → debit | `backend/leaves/controllers/leaveController.js` (approve → addLeaveDebit) |
| CCL approval | `backend/leaves/controllers/cclController.js` (processCCLAction) |
| Employee leave fields | `backend/employees/model/Employee.js` |
| Frontend register | `frontend/src/components/admin/LeaveRegisterPage.tsx`, `frontend/src/app/(workspace)/leaves/register/page.tsx` |
| Docs | `docs/LEAVES_ACCRUAL_AND_CL_BALANCE.md` |

This gives a single place to understand the leave register module, policy settings, employee storage, flow, calculations, and known bugs.
