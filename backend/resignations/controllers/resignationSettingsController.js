const ResignationSettings = require('../model/ResignationSettings');

// @desc    Get resignation policy settings
// @route   GET /api/resignations/settings
// @access  Private
exports.getSettings = async (req, res) => {
  try {
    let settings = await ResignationSettings.getActiveSettings();
    if (!settings) {
      settings = {
        noticePeriodDays: 0,
        workflow: {
          isEnabled: true,
          steps: [],
          finalAuthority: { role: 'hr', anyHRCanApprove: true },
        },
        isActive: true,
        isDefault: true,
      };
    }
    if (!settings.workflow) {
      settings.workflow = {
        isEnabled: true,
        steps: [],
        finalAuthority: { role: 'hr', anyHRCanApprove: true },
      };
    }
    res.status(200).json({ success: true, data: settings });
  } catch (error) {
    console.error('Error fetching resignation settings:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'Failed to fetch resignation settings',
    });
  }
};

// @desc    Save resignation policy settings
// @route   POST /api/resignations/settings
// @access  Private (Super Admin)
exports.saveSettings = async (req, res) => {
  try {
    const { noticePeriodDays, workflow } = req.body;
    let settings = await ResignationSettings.findOne({});
    if (!settings) {
      settings = new ResignationSettings({});
    }
    if (noticePeriodDays !== undefined) settings.noticePeriodDays = Number(noticePeriodDays) || 0;
    if (workflow) {
      settings.workflow = settings.workflow || {};
      if (workflow.isEnabled !== undefined) settings.workflow.isEnabled = !!workflow.isEnabled;
      if (workflow.steps) settings.workflow.steps = workflow.steps;
      if (workflow.finalAuthority) settings.workflow.finalAuthority = workflow.finalAuthority;
    }
    settings.updatedBy = req.user?._id;
    settings.isActive = true;
    await settings.save();
    await ResignationSettings.updateMany({ _id: { $ne: settings._id } }, { isActive: false });
    res.status(200).json({
      success: true,
      message: 'Resignation policy settings saved successfully',
      data: settings,
    });
  } catch (error) {
    console.error('Error saving resignation settings:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'Failed to save resignation settings',
    });
  }
};
