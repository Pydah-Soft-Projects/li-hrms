const mongoose = require('mongoose');
require('dotenv').config();

const Employee = require('../employees/model/Employee');
const LeaveRegister = require('../leaves/model/LeaveRegister');

async function initializeCLBalances() {
    try {
        console.log('Connecting to MongoDB...');
        await mongoose.connect(process.env.MONGO_URI || 'mongodb://localhost:27017/hrms');
        console.log('Connected to MongoDB');

        // Get all active employees
        const employees = await Employee.find({ is_active: true });
        console.log(`Found ${employees.length} active employees`);

        let processedCount = 0;
        let skippedCount = 0;

        for (const employee of employees) {
            try {
                // Check if employee already has CL transactions
                const existingCLTransactions = await LeaveRegister.find({ 
                    employeeId: employee._id,
                    leaveType: 'CL'
                });

                if (existingCLTransactions.length === 0) {
                    // Create initial CL balance transaction
                    const initialTransaction = new LeaveRegister({
                        employeeId: employee._id,
                        empNo: employee.emp_no,
                        employeeName: employee.employee_name,
                        designation: employee.designation_id?.name || 'N/A',
                        department: employee.department_id?.name || 'N/A',
                        divisionId: employee.division_id,
                        departmentId: employee.department_id,
                        dateOfJoining: employee.doj,
                        employmentStatus: employee.is_active ? 'active' : 'inactive',
                        
                        leaveType: 'CL',
                        transactionType: 'ADJUSTMENT',
                        startDate: new Date(),
                        endDate: new Date(),
                        days: 12, // Initial CL balance of 12 days
                        openingBalance: 0,
                        closingBalance: 12,
                        status: 'APPROVED',
                        reason: 'Initial CL Balance - System Initialization',
                        
                        month: new Date().getMonth() + 1,
                        year: new Date().getFullYear(),
                        financialYear: `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`,
                        
                        payrollCycleStart: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                        payrollCycleEnd: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0),
                        financialYearStart: new Date(new Date().getFullYear(), 0, 1),
                        financialYearEnd: new Date(new Date().getFullYear(), 11, 31),
                        
                        autoGenerated: true,
                        autoGeneratedType: 'INITIAL_BALANCE',
                        
                        createdBy: null, // System generated, no user
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });

                    await initialTransaction.save();
                    console.log(`âœ“ Initialized CL balance for ${employee.emp_no} (${employee.employee_name}): 12 days`);
                    processedCount++;
                } else {
                    console.log(`âš  Skipped ${employee.emp_no} (${employee.employee_name}): Already has CL transactions`);
                    skippedCount++;
                }
            } catch (error) {
                console.error(`âœ— Error processing ${employee.emp_no}:`, error.message);
                skippedCount++;
            }
        }

        console.log('\n=== CL Balance Initialization Summary ===');
        console.log(`âœ“ Successfully processed: ${processedCount} employees`);
        console.log(`âš  Skipped: ${skippedCount} employees`);
        console.log(`ðŸ“Š Total employees: ${employees.length}`);
        console.log('\nInitialization completed!');

        process.exit(0);
    } catch (error) {
        console.error('Fatal error during initialization:', error);
        process.exit(1);
    }
}

// Run the initialization
initializeCLBalances();
